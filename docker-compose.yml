version: '3.8'

services:
    mysql-db:
        image: mysql:8.0
        container_name: staymate-mysql
        restart: always
        environment:
            MYSQL_ROOT_PASSWORD: ${DB_PASSWORD:-password}
            MYSQL_DATABASE: ${DB_NAME:-staymate}
        ports:
            - "3306:3306"
        volumes:
            - mysql_data:/var/lib/mysql
        healthcheck:
            test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
            interval: 10s
            timeout: 5s
            retries: 5

    minio:
        image: minio/minio:latest
        container_name: staymate-minio
        restart: unless-stopped
        command: server /data --console-address ":9001"
        ports:
            - "9005:9000"
            - "9006:9001"
        environment:
            MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
            MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
        volumes:
            - minio_data:/data

    server:
        build:
            context: ./server
            dockerfile: Dockerfile
        container_name: staymate-backend-local
        restart: on-failure
        environment:
            - SPRING_PROFILES_ACTIVE=dev
            - DB_HOST=mysql-db
            - DB_PORT=3306
            - DB_NAME=${DB_NAME:-staymate}
            - DB_USERNAME=root
            - DB_PASSWORD=${DB_PASSWORD:-password}
            - MINIO_URL=http://minio:9000
            - MINIO_PUBLIC_URL=http://localhost:9005
        ports:
            - "8080:8080"
        depends_on:
            mysql-db:
                condition: service_healthy
            minio:
                condition: service_started
        volumes:
            - ./server:/app
            - ~/.m2:/root/.m2

    frontend:
        build:
            context: ./frontend
            dockerfile: Dockerfile.dev
        container_name: staymate-frontend-local
        restart: on-failure
        environment:
            - NEXT_PUBLIC_API_URL=http://localhost:8080
            - BACKEND_URL=http://server:8080
        ports:
            - "3000:3000"
        depends_on:
            - server
        volumes:
            - ./frontend:/app
            - /app/node_modules

volumes:
    mysql_data:
    minio_data:
